// --- CONFIG: Google Sheet API ---
const SHEET_ID = "1w6NcZ9OPhjLcZtgK98ypsxM9eV13NLT9hOf4AVe5HR4";
const API_KEY = "AIzaSyABNGnLmTXlik5fgBe_ooBI1Y5nrXKTePY";
const RANGE = "Sheet1";

let allProducts = [];
let navStructure = {};
let sheetReady = false;

// --- DATA LOAD ---
async function fetchProductsFromSheet() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
  const resp = await fetch(url);
  const data = await resp.json();
  const [headers, ...rows] = data.values;
  allProducts = rows.map(row => {
    let obj = {};
    headers.forEach((h, i) => obj[h.trim()] = (row[i] || "").trim());
    // Parse category
    const catPath = (obj.category || "").split(">").map(s => s.trim());
    obj.mainCat = catPath[0] || "";
    obj.subCat = catPath[1] || "";
    obj.catPath = obj.category || "";
    return obj;
  });
  buildNavStructure();
  sheetReady = true;
}

// --- NAV STRUCTURE ---
function buildNavStructure() {
  navStructure = {};
  for (const prod of allProducts) {
    if (!prod.mainCat) continue;
    if (!navStructure[prod.mainCat]) navStructure[prod.mainCat] = [];
    if (prod.subCat && !navStructure[prod.mainCat].includes(prod.subCat)) navStructure[prod.mainCat].push(prod.subCat);
  }
}

// --- DESKTOP MEGAMENU BUILD (for desktop only, hidden on mobile) ---
function buildWPStyleMegaMenu() {
  const megabarMenu = document.getElementById('megabarMenu');
  megabarMenu.innerHTML = '';

  // Main categories ONLY
  const mainCats = Object.keys(navStructure);
  mainCats.forEach((mainCat, idx) => {
    const li = document.createElement('li');
    li.className = "megabar-has-megamenu";
    // Main nav link (now a button to show all in mainCat)
    const mainBtn = document.createElement('button');
    mainBtn.className = 'megabar-main-link';
    mainBtn.textContent = mainCat;
    mainBtn.type = 'button';
    mainBtn.tabIndex = 0;
    mainBtn.onclick = (e) => {
      e.preventDefault();
      selectMainCategory(mainCat);
      closeAllMegamenus();
      closeMobileMenu();
    };

    // Megamenu panel (hidden on mobile, for desktop only)
    const panel = document.createElement('div');
    panel.className = 'megamenu-panel';
    const row = document.createElement('div');
    row.className = "megamenu-row";
    const col = document.createElement('div');
    col.className = "megamenu-cat-col";
    const title = document.createElement('div');
    title.className = "megamenu-title";
    title.textContent = mainCat;
    col.appendChild(title);
    const ul = document.createElement('ul');
    ul.className = "megamenu-list";
    navStructure[mainCat].forEach(sub => {
      const li2 = document.createElement('li');
      const link = document.createElement('button');
      link.className = 'megamenu-sublink';
      link.type = 'button';
      link.textContent = sub;
      link.onclick = (e) => {
        e.preventDefault();
        selectCategoryByPath(`${mainCat} > ${sub}`);
        closeAllMegamenus();
        closeMobileMenu();
      };
      li2.appendChild(link);
      ul.appendChild(li2);
    });
    col.appendChild(ul);
    row.appendChild(col);
    panel.appendChild(row);

    // Only one open at a time logic (desktop only)
    // Fix: Keep menu open as long as mouse is over the li or panel
    let closeTimeout;
    function openMenu() {
      clearTimeout(closeTimeout);
      closeAllMegamenus();
      li.classList.add('open');
      panel.style.display = "flex";
    }
    function closeMenu() {
      closeTimeout = setTimeout(() => {
        li.classList.remove('open');
        panel.style.display = "none";
      }, 200); // Give user a short time to move mouse from button to panel
    }
    function cancelCloseMenu() {
      clearTimeout(closeTimeout);
    }
    mainBtn.addEventListener('mouseenter', openMenu);
    mainBtn.addEventListener('focus', openMenu);
    mainBtn.addEventListener('click', openMenu);
    li.addEventListener('mouseleave', closeMenu);
    li.addEventListener('mouseenter', cancelCloseMenu);
    panel.addEventListener('mouseenter', cancelCloseMenu);
    panel.addEventListener('mouseleave', closeMenu);

    megabarMenu.appendChild(li);
    li.appendChild(mainBtn);
    li.appendChild(panel);
  });

  // Center logo click acts as home button
  const logoLink = document.getElementById('homeLogoLink');
  if (logoLink) {
    logoLink.onclick = (e) => {
      e.preventDefault();
      showHome();
      closeAllMegamenus();
      closeMobileMenu();
    };
  }
}

function closeAllMegamenus() {
  document.querySelectorAll('.megabar-has-megamenu').forEach(li => {
    li.classList.remove('open');
    let panel = li.querySelector('.megamenu-panel');
    if (panel) panel.style.display = "none";
  });
}

// --- HERO CAROUSEL (desktop only, hidden on mobile) ---
// ... (UNCHANGED from your current version) ...

// --- The rest of your code remains unchanged ---
// (If you want the full script, let me know. Only the megamenu logic and logo img style needed to change.)
