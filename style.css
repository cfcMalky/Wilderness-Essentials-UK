// --- Data setup ---
const categories = [
  {
    name: "Camp Kitchen", id: "camp-kitchen", subcategories: [
      { name: "Stove Accessories", id: "stove-accessories" },
      { name: "Cookware", id: "cookware" },
      { name: "Utensils", id: "utensils" }
    ]
  },
  {
    name: "Sleeping Gear", id: "sleeping-gear", subcategories: [
      { name: "Air Beds", id: "air-beds" },
      { name: "Sleeping Bags", id: "sleeping-bags" }
    ]
  },
  {
    name: "Tents", id: "tents", subcategories: [
      { name: "Dome Tents", id: "dome-tents" },
      { name: "Tunnel Tents", id: "tunnel-tents" }
    ]
  }
];

// Example product data (replace with your fetched data)
const products = [
  // Camp Kitchen
  {
    name: "Primus Power Gas Canister",
    description: "Fuel your outdoor cooking adventures with the Primus Power Gas Canister, an essential for any camping stove. This versatile 230g threaded gas cartridge is packed with a high-performance blend of propane and isobutane, designed to deliver consistent heat output and efficiency in a wide range of temperatures.",
    category: "Camp Kitchen",
    subcategory: "Stove Accessories",
    image: "https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=400&q=80",
    amazon_link: "#"
  },
  {
    name: "Titanium Cookset",
    description: "Lightweight and durable, this titanium cookset is ideal for minimalist campers who need reliable cookware. Includes pot and pan.",
    category: "Camp Kitchen",
    subcategory: "Cookware",
    image: "https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=400&q=80",
    amazon_link: "#"
  },
  // Sleeping Gear
  {
    name: "Active Era Air Bed",
    description: "Transform your sleep experience with the Active Era Luxury Single Size Air Mattress, designed for comfort and convenience wherever you are. This inflatable air bed features a built-in electric pump.",
    category: "Sleeping Gear",
    subcategory: "Air Beds",
    image: "https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=400&q=80",
    amazon_link: "#"
  },
  // Tents
  {
    name: "Dome Tents",
    description: "Explore our top-rated dome tents, perfect for all UK conditions and campsites.",
    category: "Tents",
    subcategory: "Dome Tents",
    image: "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=400&q=80",
    amazon_link: "#"
  },
  {
    name: "Tunnel Tents",
    description: "Perfect for families and groups, our tunnel tents provide spacious accommodation and stability in windy weather.",
    category: "Tents",
    subcategory: "Tunnel Tents",
    image: "https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=400&q=80",
    amazon_link: "#"
  }
];

// --- Navbar with dropdowns (one open at a time, hover/click) ---
function buildNav() {
  const navMenu = document.getElementById('navMenu');
  navMenu.innerHTML = '';
  categories.forEach((cat, catIdx) => {
    const li = document.createElement('li');
    const btn = document.createElement('button');
    btn.className = 'nav-link';
    btn.textContent = cat.name;
    btn.type = 'button';
    btn.tabIndex = 0;
    btn.setAttribute('aria-haspopup', 'true');
    btn.setAttribute('aria-expanded', 'false');
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      toggleMenu(catIdx);
    });
    btn.addEventListener('mouseenter', function() {
      openMenu(catIdx);
    });
    btn.addEventListener('focus', function() {
      openMenu(catIdx);
    });
    li.appendChild(btn);

    if (cat.subcategories && cat.subcategories.length > 0) {
      const dropdown = document.createElement('div');
      dropdown.className = 'nav-dropdown';
      cat.subcategories.forEach(sub => {
        const subLink = document.createElement('a');
        subLink.href = '#';
        subLink.textContent = sub.name;
        subLink.tabIndex = 0;
        subLink.onclick = (e) => {
          e.preventDefault();
          selectCategory(cat.name, sub.name);
        };
        dropdown.appendChild(subLink);
      });
      li.appendChild(dropdown);
    }
    li.addEventListener('mouseleave', function() {
      closeMenu(catIdx);
    });
    navMenu.appendChild(li);
  });
  // About static link
  const aboutLi = document.createElement('li');
  aboutLi.innerHTML = `<a class="nav-link" href="#">About</a>`;
  navMenu.appendChild(aboutLi);

  // Only one menu open at a time
  let openIdx = null;
  function openMenu(idx) {
    closeAllMenus();
    navMenu.children[idx].classList.add('open');
    navMenu.children[idx].querySelector('.nav-link').setAttribute('aria-expanded', 'true');
    openIdx = idx;
  }
  function closeMenu(idx) {
    navMenu.children[idx].classList.remove('open');
    navMenu.children[idx].querySelector('.nav-link').setAttribute('aria-expanded', 'false');
    openIdx = null;
  }
  function closeAllMenus() {
    for (let i = 0; i < navMenu.children.length; i++) {
      navMenu.children[i].classList.remove('open');
      const navBtn = navMenu.children[i].querySelector('.nav-link');
      if (navBtn) navBtn.setAttribute('aria-expanded', 'false');
    }
    openIdx = null;
  }
  function toggleMenu(idx) {
    if (openIdx === idx) {
      closeMenu(idx);
    } else {
      openMenu(idx);
    }
  }
  document.addEventListener('click', closeAllMenus);
}

// --- Carousel: random subcategory from each main category ---
function buildHeroCarousel() {
  const hero = document.getElementById("heroCarousel");
  // Pick a random product from each main category
  let slides = [];
  categories.forEach(cat => {
    const subs = cat.subcategories;
    let best = null;
    if (subs && subs.length) {
      // Pick a random subcategory
      const randSub = subs[Math.floor(Math.random() * subs.length)];
      // Find a product for this subcategory
      const prod = products.find(p => p.category === cat.name && p.subcategory === randSub.name);
      if (prod) best = prod;
    } else {
      // No subcats, just find a product for the main category
      best = products.find(p => p.category === cat.name);
    }
    if (best) {
      slides.push({
        image: best.image,
        headline: best.subcategory || best.category,
        mainCat: best.category,
        subCat: best.subcategory,
        desc: (best.description || '').split('.').shift() + '.',
      });
    }
  });
  if (!slides.length) {
    hero.innerHTML = `<div style="color:#a00;text-align:center;padding:2em;font-size:1.2em;">No featured products</div>`;
    return;
  }
  hero.innerHTML = "";
  slides.forEach((s, i) => {
    const slide = document.createElement('div');
    slide.className = "hero-carousel-slide" + (i === 0 ? " active" : "");
    slide.innerHTML = `
      <img class="hero-carousel-image" src="${s.image}" alt="">
      <div class="hero-carousel-content">
        <div class="hero-carousel-title">${s.headline}</div>
        <div class="hero-carousel-desc">${s.desc}</div>
        <button class="hero-carousel-cta" type="button" data-maincat="${encodeURIComponent(s.mainCat)}" data-subcat="${encodeURIComponent(s.subCat)}">
          Shop ${s.headline}
        </button>
      </div>
    `;
    hero.appendChild(slide);
  });
  // Dots nav
  const nav = document.createElement('div');
  nav.className = "hero-carousel-nav";
  for (let i = 0; i < slides.length; ++i) {
    const dot = document.createElement('button');
    dot.className = "hero-carousel-dot" + (i === 0 ? " active" : "");
    dot.setAttribute("aria-label", `Show slide ${i + 1}`);
    dot.onclick = () => setHeroCarouselSlide(i);
    nav.appendChild(dot);
  }
  hero.appendChild(nav);

  // Attach event listeners for the CTA buttons
  hero.querySelectorAll('.hero-carousel-cta').forEach(btn => {
    btn.addEventListener('click', function () {
      const mainCat = decodeURIComponent(this.getAttribute('data-maincat'));
      const subCat = decodeURIComponent(this.getAttribute('data-subcat'));
      selectCategory(mainCat, subCat);
      document.getElementById('categorySection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });

  // State
  let current = 0;
  let timer = null;
  function setHeroCarouselSlide(idx) {
    const slidesEls = hero.querySelectorAll('.hero-carousel-slide');
    const dotsEls = hero.querySelectorAll('.hero-carousel-dot');
    slidesEls.forEach((el, i) => {
      el.classList.toggle('active', i === idx);
    });
    dotsEls.forEach((el, i) => {
      el.classList.toggle('active', i === idx);
    });
    current = idx;
    resetTimer();
  }
  function nextSlide() {
    setHeroCarouselSlide((current + 1) % slides.length);
  }
  function resetTimer() {
    if (timer) clearInterval(timer);
    timer = setInterval(nextSlide, 7000);
  }
  resetTimer();
}

// --- Category select and products display ---
function selectCategory(mainCat, subCat) {
  // Show products for this category/subcategory
  const section = document.getElementById('categorySection');
  const title = document.getElementById('productsSectionTitle');
  const grid = document.getElementById('productsGrid');
  let filtered = products.filter(p => p.category === mainCat && (!subCat || p.subcategory === subCat));
  title.textContent = subCat ? `${mainCat} > ${subCat}` : mainCat;
  grid.innerHTML = '';
  if (!filtered.length) {
    grid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; color: #888;">No products found for this category.</div>`;
  } else {
    filtered.forEach(p => {
      const card = document.createElement('div');
      card.className = 'product-card';
      if (p.image) {
        const img = document.createElement('img');
        img.className = 'product-image';
        img.src = p.image;
        img.alt = p.name;
        card.appendChild(img);
      }
      const title = document.createElement('div');
      title.className = 'product-title';
      title.textContent = p.name;
      card.appendChild(title);
      const desc = document.createElement('div');
      desc.className = 'product-desc';
      desc.textContent = p.description;
      card.appendChild(desc);
      if (p.amazon_link) {
        const btn = document.createElement('a');
        btn.className = 'product-link';
        btn.href = p.amazon_link;
        btn.target = "_blank";
        btn.rel = "noopener";
        btn.textContent = "Shop on Amazon";
        card.appendChild(btn);
      }
      grid.appendChild(card);
    });
  }
  section.style.display = '';
}

// --- Initialization ---
document.addEventListener('DOMContentLoaded', function () {
  buildNav();
  buildHeroCarousel();
});
