<!-- Only the script part, replace your entire <script>...</script> with this: -->
<script>
const SHEET_ID = "1w6NcZ9OPhjLcZtgK98ypsxM9eV13NLT9hOf4AVe5HR4";
const API_KEY = "AIzaSyABNGnLmTXlik5fgBe_ooBI1Y5nrXKTePY";
const RANGE = "Sheet1";
let allProducts = [];
let categoryMap = {};
let currentMainCat = '';
let currentSubCat = '';

async function fetchProducts() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
    try {
        const response = await fetch(url);
        const data = await response.json();
        if (!data.values) {
            throw new Error(data.error ? data.error.message : 'No data returned');
        }
        const [headers, ...rows] = data.values;
        allProducts = rows.map(row => {
            const p = {};
            headers.forEach((h, i) => p[h] = row[i] || "");
            let [main, sub] = (p.category || '').split('>').map(x => x.trim());
            p.mainCat = main || '';
            p.subCat = sub || '';
            return p;
        });
        buildCategoryMap();
        buildNavbar();
        // Set default selection to first main/sub cat
        if (!currentMainCat) currentMainCat = Object.keys(categoryMap)[0];
        if (!currentSubCat) currentSubCat = (categoryMap[currentMainCat] && categoryMap[currentMainCat][0]) || '';
        renderProducts();
    } catch (err) {
        document.getElementById('productsGrid').innerHTML = `<div style="color:red;text-align:center;">Failed to load products: ${err.message}</div>`;
        console.error(err);
    }
}

function buildCategoryMap() {
    categoryMap = {};
    allProducts.forEach(p => {
        if (!p.mainCat) return;
        if (!categoryMap[p.mainCat]) categoryMap[p.mainCat] = new Set();
        if (p.subCat) categoryMap[p.mainCat].add(p.subCat);
    });
    for (let main in categoryMap) {
        categoryMap[main] = Array.from(categoryMap[main]);
    }
}

function buildNavbar() {
    const navbar = document.getElementById('navbar');
    navbar.innerHTML = '';
    const navList = document.createElement('ul');
    navList.className = 'nav-list';

    Object.entries(categoryMap).forEach(([main, subcats]) => {
        const navItem = document.createElement('li');
        navItem.className = 'nav-item';

        if (subcats.length > 0) {
            const navBtn = document.createElement('button');
            navBtn.className = 'nav-link' + (currentMainCat === main ? ' active' : '');
            navBtn.innerHTML = `${main} <span class="dropdown-arrow">▼</span>`;
            navBtn.tabIndex = 0;
            navBtn.onclick = (e) => {
                e.preventDefault();
                if(currentMainCat !== main) {
                    currentMainCat = main;
                    currentSubCat = subcats[0];
                    renderProducts();
                }
                closeAllDropdowns();
                navItem.querySelector('.dropdown-menu').classList.toggle('show');
            };

            const dropdownMenu = document.createElement('div');
            dropdownMenu.className = 'dropdown-menu';
            subcats.forEach(sub => {
                const subBtn = document.createElement('button');
                subBtn.className = 'dropdown-link' + (currentMainCat === main && currentSubCat === sub ? ' active' : '');
                subBtn.textContent = sub;
                subBtn.onclick = (ev) => {
                    ev.preventDefault();
                    currentMainCat = main;
                    currentSubCat = sub;
                    renderProducts();
                    closeAllDropdowns();
                };
                dropdownMenu.appendChild(subBtn);
            });

            navItem.appendChild(navBtn);
            navItem.appendChild(dropdownMenu);

            navBtn.addEventListener('keydown', e => {
                if (e.key === "Enter" || e.key === " ") {
                    e.preventDefault();
                    dropdownMenu.classList.toggle('show');
                }
            });
        } else {
            const navLink = document.createElement('button');
            navLink.className = 'nav-link' + (currentMainCat === main ? ' active' : '');
            navLink.textContent = main;
            navLink.onclick = (e) => {
                e.preventDefault();
                currentMainCat = main;
                currentSubCat = '';
                renderProducts();
                closeAllDropdowns();
            };
            navItem.appendChild(navLink);
        }
        navList.appendChild(navItem);
    });
    navbar.appendChild(navList);

    document.addEventListener('click', closeAllDropdowns);
    navbar.addEventListener('click', e => e.stopPropagation());
}

function closeAllDropdowns() {
    document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.remove('show'));
}

function renderProducts() {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';
    let filtered = allProducts.filter(p => {
        if (currentMainCat && currentSubCat) {
            return p.mainCat === currentMainCat && p.subCat === currentSubCat;
        } else if (currentMainCat) {
            return p.mainCat === currentMainCat;
        }
        return true;
    });
    if (filtered.length === 0) {
        grid.innerHTML = "<div style='grid-column: 1 / -1; text-align: center; color: #888;'>No products found for this category.</div>";
        return;
    }
    filtered.forEach(p => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
            <div class="product-image-container">
                <img class="product-image" src="${p.image_url || 'https://via.placeholder.com/220x220?text=No+Image'}" alt="${p.name}">
            </div>
            <div class="product-info">
                <div class="product-title">${p.name}</div>
                <div class="product-desc">${(p.description || '').replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                ${p.amazon_link ? `<a class="more-info-btn" href="${p.amazon_link}" target="_blank" rel="noopener">More Info</a>` : ''}
            </div>
        `;
        grid.appendChild(card);
    });
    document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.dropdown-link').forEach(btn => btn.classList.remove('active'));
    let navMainBtns = Array.from(document.querySelectorAll('.nav-link'));
    let navSubBtns = Array.from(document.querySelectorAll('.dropdown-link'));
    navMainBtns.forEach(btn => {
        if (btn.textContent.trim().replace('▼','').trim() === currentMainCat) btn.classList.add('active');
    });
    navSubBtns.forEach(btn => {
        if (btn.textContent.trim() === currentSubCat) btn.classList.add('active');
    });
}

fetchProducts();
</script>
